= RoboDash – Technical Design
:sectnums:
:toclevels: 3

== Overview

RoboDash is a custom motorsport dashboard built on a Raspberry Pi 5 that reads engine and vehicle data from an ECU Master ECU over CAN and renders gauges and alerts (Qt/QML first, LVGL as an option) on a compact HDMI touchscreen. It also supports a bench/simulator mode using Windows or Linux PCs for development without the car or ECU connected.

=== Goals
* Low-latency, sunlight-readable gauges (RPM, temps, pressures, lambda, battery) with alerts and shift lights.
* Native ECU Master integration (Classic/Black); adaptable to others via DBC remaps.
* Robust power/wiring for motorsport (isolation, fuses, star-ground).
* Developer-friendly: reproducible setup, CAN replay/simulation, unit and integration tests.

== System Architecture

[mermaid]
----
graph LR
    IGN[Ign-switched 12V] --> BUCK[12V→5V Buck<br/>8-10A]
    IGN --> CANHAT[CAN HAT<br/>isolated 12V]

    BUCK --> RPI[Raspberry Pi 5<br/>USB-C 5V]

    RPI --> HDMI[HDMI + USB Touch]
    HDMI --> DISPLAY[Display]

    RPI --> MCU[MCU<br/>shiftlights]
    MCU -.optional.-> RPI

    ECU[ECU Master<br/>EMU Black/Classic] -->|CAN H/L| CANHAT
    CANHAT --> RPI

    style IGN fill:#ffe6e6
    style ECU fill:#e6f3ff
    style RPI fill:#e6ffe6
    style DISPLAY fill:#fff9e6
----

== Hardware

.Component List
[cols="3,2,2,1", options="header"]
|===
|Component |Specification |Supplier |Approx. Cost

|ECU Master EMU Black
|Engine management unit with CAN output
|https://motorsportsupplies.co.uk/products/ecumaster-emu-black[Motorsport Supplies]
|£800

|Raspberry Pi 5
|4–8 GB RAM
|https://thepihut.com/products/raspberry-pi-5[The Pi Hut]
|£55–£80

|HDMI Touchscreen
|7–11" FHD, micro-HDMI + USB touch
|https://www.amazon.co.uk/dp/B0DFW5H1SK[Amazon UK]
|£80–£150

|Isolated CAN-FD HAT
|MCP2518FD dual-channel
|https://www.amazon.co.uk/dp/B0DSPYPKRG[Amazon UK]
|£30–£50

|Automotive Buck Converter
|12V → 5V, 8–10A
|https://www.amazon.co.uk/gp/product/B07YQTMQTR[Amazon UK]
|£10–£20

|MicroSD Card
|32–64 GB Class 10/A2 (or USB SSD)
|https://thepihut.com/collections/raspberry-pi-sd-cards-and-adapters[The Pi Hut]
|£8–£15

|Power Supply (Dev/Bench)
|USB-C PD 5V/5A for Pi 5
|https://thepihut.com/products/raspberry-pi-27w-usb-c-power-supply[The Pi Hut]
|£10

|Fuses
|7.5–10A (buck), 1A (HAT)
|Local auto parts store
|£5

|CAN Cable
|Twisted-pair shielded, 22 AWG
|https://www.amazon.co.uk/s?k=can+bus+cable[Amazon UK]
|£10

|CAN Connector
|DB9 or ECU Master loom connector
|https://motorsportsupplies.co.uk/[Motorsport Supplies]
|£15
|===

Wiring notes:
* Twisted pair 1.5–3 m; shield grounded at one end (ECU side).
* 120 Ω termination both ends (ECU + HAT).
* Star ground: tie ECU/Pi/HAT grounds at one point.
* Use ≥ 18 AWG for 5 V lines to minimize drop.

== Software Architecture

* `can-bridge` (Python) — reads SocketCAN, decodes DBC with cantools, publishes JSON via ZeroMQ or WebSocket.
* `dash-ui` (Qt/QML or PySide) — renders gauges, warnings, and shift bar (30–60 fps).
* `sim-tools` — CAN frame generator and log replay (SavvyCAN or can-utils).
* `healthd` (optional) — monitors CPU temp, FPS, and CAN errors.
* `io-rt` (optional MCU) — shift-lights and buzzer via Teensy or ESP32.

Data flow:

[mermaid]
----
graph LR
    CAN[SocketCAN<br/>can0] --> PYCAN[python-can]
    PYCAN --> CANTOOLS[cantools<br/>DBC decode]
    CANTOOLS --> JSON[JSON]
    JSON --> UI[Qt/QML UI]
    UI --> LOGS[NDJSON logs<br/>for replay]

    style CAN fill:#e6f3ff
    style UI fill:#e6ffe6
    style LOGS fill:#fff9e6
----

Repo layout:

robodash/
 ├─ docs/TECHNICAL_DESIGN.adoc
 ├─ firmware/
 ├─ hw/
 ├─ scripts/
 ├─ src/
 │   ├─ can-bridge/
 │   └─ dash-ui/
 └─ tests/

== ECU Integration

* Classic CAN 1 Mbit/s (default for ECU Master)
* DBC maps signal IDs, scaling, endianness via cantools
* ECU Master EMU Black/Classic CANH/CANL wiring per manual
* Do not power Pi from ECU; use buck converter

== Dependencies (Pi 5 – Bookworm 64-bit)

[source,bash]
----
sudo apt update
sudo apt install -y can-utils python3-pip
pip install python-can cantools pyzmq
sudo apt install -y qtbase5-dev qml-module-qtquick-controls2 qml-module-qtcharts
# or: pip install PySide6
----

Enable SPI CAN overlay:

[source,bash]
----
sudo nano /boot/firmware/config.txt
dtoverlay=mcp251xfd,spi0-0,clock-frequency=40000000
----

Start CAN bus:

[source,bash]
----
sudo ip link set can0 up type can bitrate 1000000
----

== Build & Run

[source,bash]
----
./scripts/setup_pi.sh
./scripts/can_bringup.sh
python3 src/can-bridge/bridge.py --iface can0 --dbc ecu_master.dbc
python3 src/dash-ui/main.py
----

== Bench Simulation (no ECU)

[source,bash]
----
sudo ip link set can0 up type can bitrate 1000000
cansend can0 360#3412000000000000
canplayer -I logs/emu_black_sample.log vcan0=can0
----

== Safety and Reliability

* Read-only root or overlay filesystem.
* systemd watchdogs for bridge and UI.
* EMI protection (ferrites, cable routing).
* Clean shutdown on ignition-off (UPS HAT optional).

== Acceptance Criteria (v0)

* UI ≥ 30 fps, < 50 ms latency.
* CAN errors < 0.1 % over 30 min bench.
* Boot to dash ≤ 20 s.

== Future Work

* Shift-lights MCU integration.
* Lap timing / GPS overlay.
* OTA updates and config UI.
